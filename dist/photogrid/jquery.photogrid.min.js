/*! Copyright@XTG, 2014-11-26 */
!function($){var imgReady=function(){var a=[],b=null,c=function(){for(var b=0;b<a.length;b++)a[b].end?a.splice(b--,1):a[b]();!a.length&&d()},d=function(){clearInterval(b),b=null};return function(d,e,f,g){var h,i,j,k,l,m;return"string"==typeof d?(m=new Image,m.src=d):m=$(d).get(0),m.complete?(e.call(m),void(f&&f.call(m))):(i=m.width,j=m.height,m.onerror=function(){g&&g.call(m),h.end=!0,m=m.onload=m.onerror=null},h=function(){k=m.width,l=m.height,(k!==i||l!==j||k*l>1024)&&(e.call(m),h.end=!0)},h(),m.onload=function(){!h.end&&h(),f&&f.call(m),m=m.onload=m.onerror=null},void(h.end||(a.push(h),null===b&&(b=setInterval(c,40)))))}}(),Utils=function(){return{isHttpUrl:function(a){var b=new RegExp("^(http|https)://","i");return b.test(a)},getDomainFormUrl:function(a){if("undefined"==typeof a||null===a)return"";var b=a.match(/^https?\:\/\/([^\/?#]+)(?:[\/?#]|$)/i),c=b&&b[1];return c},getSize:function(a){return a=$.trim(""+a),a.match(/^\d+$/)?a+"px":a},random:function(a,b){return Math.floor(a+Math.random()*(b-a))},randomDateLong:function(a,b){a||(a=-7),b||(b=7);var c=new Date,d=c.getTime(),e=864e5,f=Math.min(a,b),g=Math.max(a,b),h=d+f*e,i=d+g*e;return this.random(h,i)},noop:function(){}}}(),ImageView=function(){function ImageView(a,b,c){this.$element=$(b),this.$item=$(a),this.opts=$.extend(!0,{},ImageView.defaults,c),this.create(),this.update(),this.initEvent()}function noop(){}return ImageView.prototype={create:function(){this.$details=$('<div class="photogrid-iv-details"></div>'),this.opts.detailsTemplate||(this.$title=$('<div class="photogrid-iv-details-title">Title here</div>'),this.$baseinfo=$('<div class="photogrid-iv-details-baseinfo"></div>').append(this.$domain=$('<a href="#" target="_blank">www.TagFay.com</a>'),"<span> - </span>",this.$dimensions=$("<span>1024 x 768</span>")),this.$desc=$('<div class="photogrid-iv-details-desc">Description here</div>'),this.$pageLink=$('<a href="#" class="photogrid-iv-btn" id="pgIvBtnViewPage" target="_blank"><span class="photogrid-iv-btn-txt">访问网页</span></a>'),this.$srcLink=$('<a href="#" class="photogrid-iv-btn" id="pgIvBtnViewSrc" target="_blank"><span class="photogrid-iv-btn-txt">查看图片</span></a>'),this.$details.append(this.$title,this.$baseinfo,this.$desc,this.$pageLink,this.$srcLink)),this.$imageView=$('<div class="photogrid-iv"></div>').append(this.$imageViewWapper=$('<div class="photogrid-iv-wapper"></div>').append(this.$imgbox=$('<div class="photogrid-iv-imgbox" style="width:'+this.opts.imageViewImageBoxWidth+';"></div>').append(this.$loading=$('<div class="photogrid-loader"><b></b><b></b><b></b></div>'),this.$shownImgLink=$('<a href="#" target="_blank"></a>').append(this.$shownImg=$('<img class="photogrid-iv-img"/>'))),this.$sep=$('<div class="photogrid-iv-sep"></div>'),this.$details,this.$btnClose=$('<span class="photogrid-iv-close" id="pgIvBtnClose"></span>'),this.$btnPrev=$('<span class="photogrid-iv-btn photogrid-iv-nv-btn photogrid-iv-nv-btn-left" id="pgIvBtnPrev"><div></div></span>'),this.$btnNext=$('<span class="photogrid-iv-btn photogrid-iv-nv-btn photogrid-iv-nv-btn-right" id="pgIvBtnNext"><div></div></span>'))).css("height",this.opts.height),this.$item.append(this.$imageView.hide()),this.ivHeight=this.$imageView.outerHeight(!0)},update:function($item){var self=this;$item&&(this.$item=$item),this.itemHeight=this.$item.outerHeight(),this.$imageView.is(":visible")&&this.restoreItem(),this.$item.addClass("photogrid-expanded").height(this.$item.height()+this.ivHeight),this.$currentItem=this.$item;var $allItems=this.$element.find(this.opts.itemSelector),currentIdx=$allItems.index(this.$currentItem);0===currentIdx?this.$btnPrev.hide():this.$btnPrev.show(),currentIdx===$allItems.length-1?this.$btnNext.hide():this.$btnNext.show();var itemData=this.$currentItem.data("itemData");if(!itemData){var $databox=this.$currentItem.find(this.opts.itemDataSelector);if($databox.length>0){var dataStr="";if(dataStr=$.trim($databox.is("input:text")||$databox.is("textarea")?$databox.val():$databox.text()),JSON)try{itemData=JSON.parse(dataStr)}catch(e){itemData=eval("("+dataStr+")")}else itemData=eval("("+dataStr+")");itemData&&this.$currentItem.data("itemData",itemData)}}$.isPlainObject(itemData)&&(!itemData.dimensions&&this.$currentItem.data("dimensions")&&(itemData.dimensions=this.$currentItem.data("dimensions")),this.opts.detailsTemplate?this.$details.empty().append(this.opts.templateRender&&$.isFunction(this.opts.templateRender)?this.opts.templateRender(this.opts.detailsTemplate,itemData):this.opts.detailsTemplate(itemData)):(this.$title.html(itemData.title),this.$domain.html(itemData.domain).attr("href",itemData.domain),this.$desc.html(itemData.description),this.$srcLink.attr("href",itemData.srcLink),itemData.dimensions&&this.$dimensions.text(itemData.dimensions),itemData.pageLink?this.$pageLink.attr("href",itemData.pageLink).show():this.$pageLink.hide())),this.$loading&&this.$loading.addClass("show-loader");var $thisImg=this.$currentItem.find("img").filter(":first"),newSrc=$thisImg.data("src")||$thisImg.attr("src");this.$shownImgLink.attr("href",newSrc),this.$shownImg.css("margin-top",0).hide().load(function(){if(self.$loading&&self.$loading.removeClass("show-loader"),self.$imgbox.height()>self.$shownImg.height()&&self.$shownImg.css("margin-top",(self.$imgbox.height()-self.$shownImg.height())/2+"px"),self.$shownImg.fadeIn(350),!self.opts.detailsTemplate&&itemData&&!itemData.dimensions){var a=self.$shownImg.get(0);itemData.dimensions=a.naturalWidth+" x "+a.naturalHeight,self.$currentItem.data("dimensions",itemData.dimensions),self.$dimensions.text(itemData.dimensions)}}).error(function(){self.$loading&&self.$loading.removeClass("show-loader"),self.opts.pic404&&($(this).attr("src",self.opts.pic404),self.$shownImgLink.attr("href",self.opts.pic404),self.$currentItem.addClass("photogrid-iv-img-404"))}).attr("src",newSrc),this.$imageView.detach().appendTo(this.$currentItem).show();var wapperWidth=this.$imageViewWapper.width(),imgboxWidth=this.$imgbox.outerWidth(!0),sepWidth=this.$sep.outerWidth(!0),detailsMaxWidth=wapperWidth-imgboxWidth-sepWidth-10,detailsInnerWidth=detailsMaxWidth-(this.$details.outerWidth(!0)-this.$details.width());this.$details.width(detailsInnerWidth),this.positionImageView()},initEvent:function(){var a=this;this.$btnPrev.off("click dblclick").on("click dblclick",function(){var b=a.$element.find(a.opts.itemSelector),c=b.index(a.$currentItem);if(0>=c)return!1;var d=$(b.get(c-1));return a.update(d),!1}),this.$btnNext.off("click dblclick").on("click dblclick",function(){var b=a.$element.find(a.opts.itemSelector),c=b.index(a.$currentItem);if(c>=b.length-1)return!1;var d=$(b.get(c+1));return a.update(d),!1}),this.$btnClose.off("click dblclick").on("click dblclick",function(){a.hide()})},show:function(){this.setItem(),this.$imageView.show()},hide:function(){this.$imageView.hide(),this.restoreItem()},toggle:function(){this.$imageView.is(":visible")?this.hide():this.show()},positionImageView:function(){var a=this.$currentItem.offset().top,b=a+1*this.itemHeight/3;$("body").scrollTop(b)},setItem:function(){this.$currentItem&&this.$currentItem.addClass("photogrid-expanded").height(this.$currentItem.height()+this.ivHeight)},restoreItem:function(){this.$currentItem&&this.$currentItem.removeClass("photogrid-expanded").height(this.$currentItem.height()-this.ivHeight)},destroy:function(){this.restoreItem(),this.$imageView.remove()}},ImageView.defaults={detailsTemplate:null,templateRender:null,height:440,itemSelector:".photogrid-item",itemDataSelector:".photogrid-item-data",pic404:null},ImageView}(),PhotoGrid=function(){var a=[],b=function(a,b){var c=this,d="pgid_"+Utils.randomDateLong();this.$element=$(a),this.$element.attr("pgid",d),this.opts=$.extend(!0,{},$.fn.photogrid.defaults,b),this._config={itemCls:"photogrid-item",itemDataCls:"photogrid-item-data",firstItemCls:"photogrid-first-item",lastItemCls:"photogrid-last-item",lastRowCls:"photogrid-last-row",cationCls:"photogrid-caption",cationTextCls:"photogrid-caption-text"},this.inited=!1,this.opts.initAfterWinLoad?(this.$element.css("opacity",0),this.$winLoader=$('<div class="photogridWinLoader photogrid-loader dark-loader show-loader"><b></b><b></b><b></b></div>'),this.$element.before(this.$winLoader),$(window).load(function(){$(document).ready(function(){c._init()})}),c.opts.winLoadTimeout=parseInt(c.opts.winLoadTimeout),setTimeout(function(){c._init()},c.opts.winLoadTimeout)):this._init()};return b.imgReady=imgReady,$.PhotoGrid=b,b.getAll=function(){return a},b.destroyAll=function(){},b.prototype={_init:function(){this.inited,this.inited=!0;a.push(this),this.$element.data("photogrid",this),this.$element.addClass("photogrid"),this.opts.rowHeight=parseInt(this.opts.rowHeight),this.opts.minMargin=parseInt(this.opts.minMargin),this.opts.maxMargin=parseInt(this.opts.maxMargin),this.opts.endlessTimes=parseInt(this.opts.endlessTimes),this.opts.endlessDistance=parseInt(this.opts.endlessDistance),this.opts.endlessTimeout=parseInt(this.opts.endlessTimeout),this.opts.minImageSize=parseInt(this.opts.minImageSize),this.opts.imageViewImageBoxWidth=Utils.getSize(this.opts.imageViewImageBoxWidth),this.opts.rowHeight&&this.$element.find(itemSelector).find("img").filter(":first").attr("height",this.opts.rowHeight),this.initLayout(),this.initEvents(),this.opts.initAfterWinLoad&&(this.$element.css("opacity",1),this.$winLoader.remove()),$.isFunction(this.opts.onInited)&&this.opts.onInited()},initLayout:function(a){for(var b=this,c=this.$element.get(0),d=this.opts,e=0,f=[],a=a||c.querySelectorAll(d.itemSelector),g=a.length,h=0;g>h;++h){var i=a[h],j=$(i),k=j.find("img").first();if(k.get(0).naturalWidth<d.minImageSize||k.get(0).naturalHeight<d.minImageSize)j.remove();else{j.is("[style]")&&!j.data("style")&&j.data("style",j.attr("style")),j.removeAttr("style").removeClass([d.firstItemClass,d.lastRowClass,b._config.firstItemCls,b._config.lastItemCls,b._config.lastRowCls].join(" ")).addClass(b._config.itemCls),j.find(b.opts.itemDataSelector).addClass(b._config.itemDataCls);var l=j.find("img").filter(":first[title]");l.data("title")||l.data("title",l.attr("title")),l.removeAttr("title"),b.opts.caption&&b.genCaptionView(i)}}for(var m=c.clientWidth-parseFloat($(c).css("padding-left"))-parseFloat($(c).css("padding-right")),n=[],o=0;g>o;++o)n[o]={outerWidth:a[o].offsetWidth,height:a[o].offsetHeight};for(var h=0;g>h;++h){if(e+=n[h].outerWidth,f.push(a[h]),h===g-1)for(var p=0;p<f.length;p++)0===p&&(f[p].className+=" "+d.lastRowClass+" "+b._config.lastRowCls),f[p].style.marginRight=p<f.length-1?d.minMargin+"px":0;if(e+d.maxMargin*(f.length-1)>m){var q=e+d.maxMargin*(f.length-1)-m,r=f.length,s=(d.maxMargin-d.minMargin)*(r-1);if(q>s){var t=d.minMargin;q-=(d.maxMargin-d.minMargin)*(r-1)}else{var t=d.maxMargin-q/(r-1);q=0}for(var u,v=0,p=0;p<f.length;p++){u=f[p];var w=n[h+parseInt(p)-f.length+1].outerWidth,x=w-w/e*q,y=Math.round(n[h+parseInt(p)-f.length+1].height*(x/w));v+1-x%1>=.5?(v-=x%1,x=Math.floor(x)):(v+=1-x%1,x=Math.ceil(x)),u.style.cssText="width: "+x+"px;height: "+y+"px;margin-right: "+(p<f.length-1?t:0)+"px",0===p&&(u.className+=" "+d.firstItemClass+b._config.firstItemCls);var z=$(u).find("img:first");z.css("height",y)}f=[],e=0}}},initEvents:function(){var a=this;this.opts.resize&&$(window).off("resize.photogrid").on("resize.photogrid",function(){a.initLayout()}),$.isFunction(this.opts.endless)&&(this.isLoadingItems=!1,this.endlessable=!0,this.endlessTimes=this.opts.endlessTimes?this.opts.endlessTimes:9999,$(window).off("scroll.photogrid").on("scroll.photogrid",function(){!a.isLoadingItems&&a.endlessTimes&&a.endlessable&&$(window).scrollTop()+$(window).height()>=$(document).height()-a.opts.endlessDistance&&(a.isLoadingItems=!0,a.endlessTimes--,setTimeout(function(){a.appended(),a.isLoadingItems=!1},a.opts.endlessTimeout),a.opts.endless(function(b){b||a.appended(),a.isLoadingItems=!1},imgReady))})),this.initItemEvents()},initItemEvents:function(a){var b=this;a=a||this.$element.find(this.opts.itemSelector),a.children("a").off("click.photogrid").on("click.photogrid",function(a){var c=$(this).parent();if(b.imageView)b.imageView.$currentItem.is(c)?b.imageView.toggle():b.imageView.update(c);else{var d={detailsTemplate:b.opts.detailsTemplate,templateRender:b.opts.templateRender,height:b.opts.imageViewheight,imageViewImageBoxWidth:b.opts.imageViewImageBoxWidth,itemSelector:"."+b._config.itemCls,itemDataSelector:"."+b._config.itemDataCls,pic404:b.opts.pic404};b.imageView=new ImageView(c,b.$element,d)}return a.preventDefault(),!1})},appended:function(){var a=this.$element.find("."+this._config.lastRowCls),b=a.nextAll().add(a);this.initLayout(b),this.initItemEvents(b),$.isFunction(this.opts.onAppended)&&this.opts.onAppended()},updated:function(){this.initLayout(),this.imageView.destroy(),delete this.imageView,this.initItemEvents(),$.isFunction(this.opts.onUpdated)&&this.opts.onUpdated()},genCaptionView:function(a){var b=$(a),c=b.find("img").filter(":first"),d=this.genCaptionText(c,b),e=$(['<div class="photogrid-caption">','<span class="photogrid-caption-text">'+d+"</span>","</div>"].join(""));e.insertAfter(c)},genCaptionText:function(a,b){a=$(a).get(0);var c="";Utils.isHttpUrl(a.src)&&(c=" - "+Utils.getDomainFormUrl(a.src));var d=a.naturalWidth+" x "+a.naturalHeight;return b.data("dimensions",d),d+c},stopEndless:function(){this.endlessable=!1},destroy:function(){this.$element.find(this.opts.itemSelector).each(function(){var a=$(this);a.data("style")&&a.attr("style",a.data("style")),a.removeClass([this.opts.firstItemClass,this.opts.lastRowClass,this._config.firstItemCls,this._config.lastItemCls,this._config.lastRowCls,this._config.itemCls].join(" ")).off(".photogrid");var b=a.find("img").filter(":first");b.data("title")&&b.attr("title",b.data("title"))}),this.$element.find(".photogrid-caption").remove(),this.$element.removeClass("photogrid"),this.$element.removeData("photogrid"),$(window).off(".photogrid"),this.imageView.destroy(),delete this.opts,delete this.$element,a.splice($.inArray(this,a),1)},noop:function(){}},b}();$.fn.photogrid=function(a){if("string"==typeof a){var b=arguments,c=a;if("_"==c.charAt(0))return this;if(Array.prototype.shift.call(b),"get"!=c.substr(0,3))return this.each(function(){var a=$(this).data("photogrid");a&&a[c]&&a[c].apply(a,b)});var d=$($(this)[0]),e=d.data("photogrid");if(e&&e[c])return e[c].apply(e,b)}var f=$.extend(!0,{},$.fn.photogrid.defaults,a);return this.each(function(){0!=$(f.itemSelector,this).length&&new PhotoGrid(this,f)})},$.fn.photogrid.defaults={itemSelector:".item",itemDataSelector:".data",rowHeight:null,minMargin:6,maxMargin:15,resize:!0,caption:!0,initAfterWinLoad:!1,winLoadTimeout:3e3,minImageSize:0,firstItemClass:"",lastRowClass:"",onInited:null,onAppended:null,onUpdated:null,endless:null,endlessTimes:0,endlessDistance:0,endlessTimeout:3e3,detailsTemplate:null,templateRender:null,imageViewheight:440,imageViewImageBoxWidth:"65%",pic404:null}}(jQuery);